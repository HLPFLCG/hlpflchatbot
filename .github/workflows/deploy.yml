name: Deploy HLPFL Chatbot to hlpfl.io

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Wrangler
      run: npm install -g wrangler
      
    - name: Validate configuration
      run: |
        echo "üîç Validating wrangler.toml..."
        # Check if wrangler.toml is valid by attempting to read config
        wrangler whoami
        echo "üîç Checking worker syntax..."
        node -c worker.js
        echo "üîç Configuration validation passed!"
        
    - name: Deploy to Staging
      if: github.event_name == 'push' || github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
      run: |
        echo "üöÄ Deploying to staging..."
        wrangler deploy --env staging
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        
    - name: Test Staging Deployment
      if: github.event_name == 'push' || github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
      run: |
        echo "üß™ Testing staging deployment..."
        sleep 30 # Wait for deployment to propagate
        
        # Test health endpoint
        for i in {1..10}; do
          if curl -f https://staging.hlpfl.io/api/health; then
            echo "‚úÖ Staging health check passed!"
            break
          fi
          echo "‚è≥ Waiting for staging deployment... (attempt $i/10)"
          sleep 10
        done
        
        # Test chat endpoint
        curl -X POST https://staging.hlpfl.io/api/chat \
          -H "Content-Type: application/json" \
          -d '{"message": "Hello from CI/CD"}' || {
            echo "‚ùå Staging chat test failed!"
            exit 1
          }
        echo "‚úÖ Staging deployment tests passed!"
        
    - name: Deploy to Production
      if: github.ref == 'refs/heads/main' && github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
      run: |
        echo "üöÄ Deploying to production..."
        wrangler deploy --env production
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        
    - name: Test Production Deployment
      if: github.ref == 'refs/heads/main' && github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
      run: |
        echo "üß™ Testing production deployment..."
        sleep 30 # Wait for deployment to propagate
        
        # Test health endpoint
        for i in {1..10}; do
          if curl -f https://hlpfl.io/api/health; then
            echo "‚úÖ Production health check passed!"
            break
          fi
          echo "‚è≥ Waiting for production deployment... (attempt $i/10)"
          sleep 10
        done
        
        # Test chat endpoint
        curl -X POST https://hlpfl.io/api/chat \
          -H "Content-Type: application/json" \
          -d '{"message": "Hello from production deployment!"}' || {
            echo "‚ùå Production chat test failed!"
            exit 1
          }
        echo "‚úÖ Production deployment tests passed!"
        
    - name: Deployment Summary
      run: |
        echo "üéâ Deployment completed successfully!"
        echo ""
        echo "üìç API Endpoints:"
        echo "  ‚Ä¢ Staging: https://staging.hlpfl.io/api/chat"
        echo "  ‚Ä¢ Production: https://hlpfl.io/api/chat"
        echo ""
        echo "üß™ Health Endpoints:"
        echo "  ‚Ä¢ Staging: https://staging.hlpfl.io/api/health"
        echo "  ‚Ä¢ Production: https://hlpfl.io/api/health"
        echo ""
        echo "üìã Next Steps:"
        echo "  1. Test the embedded components on hlpfl.org"
        echo "  2. Monitor API performance and logs"
        echo "  3. Set up analytics if desired"

  security:
    runs-on: ubuntu-latest
    name: Security Scan
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Run security audit
      run: |
        echo "üîí Running security audit..."
        npm audit --audit-level=moderate || echo "‚ö†Ô∏è  Security issues found - review manually"
        
    - name: Check for secrets
      run: |
        echo "üîç Checking for potential secrets..."
        # More specific pattern to avoid false positives in package files
        if grep -r "sk-[a-zA-Z0-9]" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.json" --exclude="*.yml" --exclude="*.yaml"; then
          echo "‚ùå Potential API keys found!"
          exit 1
        fi
        echo "‚úÖ No obvious secrets found"